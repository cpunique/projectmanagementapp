rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the owner (for read/update operations)
    function isOwner() {
      return isAuthenticated() && request.auth.uid == resource.data.ownerId;
    }

    // Check if user is an editor (has edit permissions)
    function isEditor() {
      return isAuthenticated() &&
             resource.data.editorUserIds != null &&
             request.auth.uid in resource.data.editorUserIds;
    }

    // Check if user is owner or editor (can modify board)
    // For backwards compatibility: if editorUserIds doesn't exist, fall back to checking sharedWithUserIds
    function canEdit() {
      return isOwner() ||
             isEditor() ||
             // Backwards compatibility: allow all collaborators to edit if editorUserIds doesn't exist
             (resource.data.editorUserIds == null &&
              resource.data.sharedWithUserIds != null &&
              request.auth.uid in resource.data.sharedWithUserIds);
    }

    // Validate board data structure and constraints
    // Note: sharedWithUserIds is optional for backwards compatibility with existing boards
    function isValidBoardData() {
      let data = request.resource.data;
      return data.keys().hasAll(['id', 'name', 'columns', 'ownerId', 'sharedWith']) &&
             data.name is string &&
             data.name.size() > 0 &&
             data.name.size() <= 100 &&
             data.columns is list &&
             data.columns.size() <= 50 &&
             data.sharedWith is list &&
             data.ownerId is string;
    }

    // Check document size is reasonable (< 1MB)
    function isValidBoardSize() {
      return request.resource.size() < 1000000;
    }

    // Ensure ownerId never changes during updates
    function ownershipUnchanged() {
      return request.resource.data.ownerId == resource.data.ownerId;
    }

    // Allow deletion of 'default-board' specifically (corrupted board recovery)
    function isDefaultBoardCorrupted(boardId) {
      return boardId == 'default-board' && isAuthenticated();
    }

    // ============================================
    // Users Collection Rules
    // ============================================

    match /users/{userId} {
      // Users can read any user document (needed for board sharing feature to lookup by email)
      allow read: if isAuthenticated();

      // Users can create their own document
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Users can update their own document
      allow update: if isAuthenticated() && request.auth.uid == userId;

      // Prevent user deletion
      allow delete: if false;
    }

    // ============================================
    // Boards Collection Rules
    // ============================================

    match /boards/{boardId} {

      // Read: Owner can read, OR user is in sharedWithUserIds (collaborators can read)
      // Backwards compatible: works even if sharedWithUserIds doesn't exist
      allow read: if isAuthenticated() &&
                    (resource.data.ownerId == request.auth.uid ||
                     (resource.data.sharedWithUserIds != null &&
                      request.auth.uid in resource.data.sharedWithUserIds));

      // Create: Can create if setting self as owner
      allow create: if isAuthenticated() &&
                      request.resource.data.ownerId == request.auth.uid &&
                      isValidBoardData() &&
                      isValidBoardSize();

      // Update: Owner can update, OR user is an editor (viewers can only read)
      allow update: if isAuthenticated() &&
                      ownershipUnchanged() &&
                      isValidBoardData() &&
                      isValidBoardSize() &&
                      canEdit();

      // Delete: Only owner can delete, or allow special case for corrupted 'default-board'
      allow delete: if (isAuthenticated() && isOwner()) || isDefaultBoardCorrupted(boardId);
    }

    // ============================================
    // Board Activities Subcollection Rules
    // ============================================

    match /boards/{boardId}/activities/{activityId} {
      // Read: Anyone who can read the board can read its activities
      allow read: if isAuthenticated() &&
                    (get(/databases/$(database)/documents/boards/$(boardId)).data.ownerId == request.auth.uid ||
                     (get(/databases/$(database)/documents/boards/$(boardId)).data.sharedWithUserIds != null &&
                      request.auth.uid in get(/databases/$(database)/documents/boards/$(boardId)).data.sharedWithUserIds));

      // Create: Authenticated user logging their own activity
      allow create: if isAuthenticated() &&
                      request.resource.data.actorId == request.auth.uid;

      // Activities are immutable â€” no updates or deletes
      allow update, delete: if false;
    }

    // ============================================
    // Demo Configs Collection Rules
    // ============================================

    match /demo-configs/{configId} {
      // Anyone can read demo configs (needed for landing page to fetch demo board)
      allow read: if true;

      // Only the designated admin can write
      allow write: if isAuthenticated() &&
                      request.auth.uid == 'OWDbFDLVxgfW6ftSXoQBurAvAiB2';
    }

    // ============================================
    // Presence Collection Rules
    // ============================================

    match /presence/{userId} {
      // Anyone authenticated can read presence (to see who's online)
      allow read: if isAuthenticated();

      // Users can only write their own presence status
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================
    // Notifications Collection Rules
    // ============================================

    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() && resource.data.targetUserId == request.auth.uid;

      // Authenticated users can create notifications for any user (when mentioning someone)
      allow create: if isAuthenticated() &&
                      request.resource.data.targetUserId is string &&
                      request.resource.data.fromUserId == request.auth.uid;

      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() && resource.data.targetUserId == request.auth.uid;

      // Users can delete their own notifications
      allow delete: if isAuthenticated() && resource.data.targetUserId == request.auth.uid;
    }

    // ============================================
    // Catch-All (Deny by default)
    // ============================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
